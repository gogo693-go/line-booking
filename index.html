<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LINE 預約</title>

<style>
  body { margin:0; background:#f6f7fb; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; }
  .app { min-height:100vh; display:flex; flex-direction:column; }
  .content { padding:16px; flex:1; }
  .card { background:#fff; border-radius:16px; padding:16px; margin-bottom:16px; }
  .demo-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .demo { border:2px solid #ddd; border-radius:14px; overflow:hidden; cursor:pointer; background:#fff; }
  .demo.active { border-color:#06c755; box-shadow:0 0 0 3px rgba(6,199,85,.15); }
  .demo img { width:100%; height:120px; object-fit:cover; display:block; }
  .demo .txt { padding:8px; text-align:center; font-weight:800; }
  label { display:block; margin-top:12px; margin-bottom:6px; font-weight:800; }
  input, select, textarea { width:100%; padding:12px; border-radius:12px; border:1px solid #ddd; font-size:16px; box-sizing:border-box; }
  .row { display:grid; grid-template-columns:1fr 120px; gap:8px; }
  textarea { min-height:88px; resize:none; }
  .footer { padding:12px; background:#fff; border-top:1px solid #eee; }
  button { width:100%; height:56px; border-radius:16px; border:none; background:#06c755; color:#fff; font-size:18px; font-weight:900; cursor:pointer; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .msg { margin-top:10px; text-align:center; font-weight:900; }
  .msg.ok { color:#06c755; }
  .msg.err { color:#d93025; }
</style>
</head>

<body>
<div class="app">
  <div class="content">
    <div class="card">
      <h2>① 選擇服務</h2>
      <div class="demo-grid" id="demoGrid"></div>
    </div>

    <div class="card">
      <h2>② 客戶資料</h2>

      <label>姓氏</label>
      <div class="row">
        <input id="lastName" placeholder="例如：王" />
        <select id="title">
          <option value="">稱謂</option>
          <option value="先生">先生</option>
          <option value="小姐">小姐</option>
        </select>
      </div>

      <label>聯絡電話</label>
      <input id="phone" placeholder="0912345678" inputmode="tel" />

      <label>備註（可選）</label>
      <textarea id="note" placeholder="想預約時間、需求簡述…"></textarea>
    </div>
  </div>

  <div class="footer">
    <button id="submitBtn">我要預約</button>
    <div class="msg" id="msg"></div>
  </div>
</div>

<!-- 隱藏 iframe：用來送出表單，不會 CORS，不會 Failed to fetch -->
<iframe name="submitFrame" id="submitFrame" style="display:none;"></iframe>

<!-- 隱藏表單：用 POST 丟到 Apps Script /exec -->
<form id="postForm" target="submitFrame" method="POST" style="display:none;">
  <input name="demo" />
  <input name="lastName" />
  <input name="title" />
  <input name="phone" />
  <input name="note" />
</form>

<script>
/* ===== 只要改這一行：貼「網頁應用程式」那個 /exec ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbzXIV_n3MEPgLhWWP-tFUPaMGX6T6Cxa5vxz6aUSP37I_sX2uyYywoTz2-P-ycMVVD_/exec";
/* ======================================================== */

const DEMOS = [
  { id: "Demo A", img: "https://picsum.photos/400/300?1" },
  { id: "Demo B", img: "https://picsum.photos/400/300?2" }
];

let selectedDemo = "";

const $ = (id) => document.getElementById(id);
const demoGrid = $("demoGrid");
const msgEl = $("msg");
const btn = $("submitBtn");
const form = $("postForm");

function showMsg(text, ok) {
  msgEl.textContent = text || "";
  msgEl.className = "msg " + (ok ? "ok" : "err");
}

function renderDemos() {
  demoGrid.innerHTML = "";
  DEMOS.forEach((d) => {
    const el = document.createElement("div");
    el.className = "demo";
    el.innerHTML = `<img src="${d.img}" alt=""><div class="txt">${d.id}</div>`;
    el.onclick = () => {
      selectedDemo = d.id;
      document.querySelectorAll(".demo").forEach(x => x.classList.remove("active"));
      el.classList.add("active");
      showMsg("", true);
    };
    demoGrid.appendChild(el);
  });
  // 預設選第一個
  demoGrid.querySelector(".demo")?.click();
}
renderDemos();

// 監聽後端回傳（iframe postMessage）
let waiting = false;
let timer = null;

window.addEventListener("message", (event) => {
  const data = event.data;
  if (!data || data.source !== "line-booking") return;

  // 收到回覆就結束等待
  waiting = false;
  if (timer) clearTimeout(timer);
  btn.disabled = false;

  if (data.success) showMsg("✅ 預約成功", true);
  else showMsg("❌ " + (data.message || "預約失敗"), false);
});

btn.onclick = () => {
  const lastName = $("lastName").value.trim();
  const title = $("title").value.trim();
  const phone = $("phone").value.trim();
  const note = $("note").value.trim();

  // 必填提示要精準
  if (!selectedDemo) return showMsg("請先選擇服務", false);
  if (!lastName) return showMsg("請填寫姓氏", false);
  if (!title) return showMsg("請選擇稱謂", false);
  if (!/^\d{10}$/.test(phone)) return showMsg("請填寫正確電話", false);

  // 送出
  showMsg("送出中…", true);
  btn.disabled = true;
  waiting = true;

  form.action = API_URL;
  form.elements["demo"].value = selectedDemo;
  form.elements["lastName"].value = lastName;
  form.elements["title"].value = title;
  form.elements["phone"].value = phone;
  form.elements["note"].value = note;

  // 超時保護：12 秒沒回就當失敗
  if (timer) clearTimeout(timer);
  timer = setTimeout(() => {
    if (!waiting) return;
    waiting = false;
    btn.disabled = false;
    showMsg("❌ 預約失敗，請稍後再試", false);
  }, 12000);

  form.submit();
};
</script>
</body>
</html>
