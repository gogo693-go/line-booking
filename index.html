<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>LINE 預約</title>

<style>
:root{
  --ui:1;
  --radius:18px;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC";
  background:#f6f7fb;
}
.app{min-height:100vh;display:flex;flex-direction:column}
.content{flex:1;padding:12px;box-sizing:border-box}
.card{
  background:#fff;
  border-radius:var(--radius);
  padding:14px;
  margin-bottom:12px;
}
.demo-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.demo{
  border:2px solid #e5e7eb;
  border-radius:16px;
  overflow:hidden;
  cursor:pointer;
}
.demo.active{border-color:#06c755}
.demo img{width:100%;height:110px;object-fit:cover}
.demo .txt{text-align:center;font-weight:700;padding:6px}
label{font-weight:700;display:block;margin:10px 0 4px}
input,select,textarea{
  width:100%;padding:10px;border-radius:12px;
  border:1px solid #ddd;font-size:16px;
}
textarea{resize:none;height:80px}
.footer{
  position:sticky;bottom:0;
  background:#f6f7fb;padding:12px;border-top:1px solid #eee
}
button{
  width:100%;height:54px;
  border:0;border-radius:16px;
  background:#06c755;color:#fff;
  font-size:18px;font-weight:800;
}
.msg{text-align:center;margin-top:8px;font-weight:800}
.msg.ok{color:#16a34a}
.msg.err{color:#dc2626}
</style>
</head>

<body>
<div class="app">
  <div class="content">

    <div class="card">
      <h2>① 模組套用</h2>
      <div class="demo-grid" id="demoGrid"></div>
    </div>

    <div class="card">
      <h2>② 客戶資料</h2>

      <label>姓氏</label>
      <input id="lastName" placeholder="例如：王">

      <label>稱謂</label>
      <select id="title">
        <option value="">請選擇</option>
        <option value="先生">先生</option>
        <option value="小姐">小姐</option>
      </select>

      <label>聯絡電話</label>
      <input id="phone" inputmode="tel" placeholder="0912345678">

      <label>備註（可選）</label>
      <textarea id="note"></textarea>
    </div>

  </div>

  <div class="footer">
    <button id="submitBtn">我要預約</button>
    <div class="msg" id="msg"></div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID = "2008866230-0043vGnl";
const API_URL = "https://script.google.com/macros/s/你的_EXEC_URL/exec";

const DEMOS = [
  { id:"Demo A", name:"Demo A", img:"https://picsum.photos/600/400?1" },
  { id:"Demo B", name:"Demo B", img:"https://picsum.photos/600/400?2" },
];

let selectedDemo = "";
let userId = "";
let displayName = "";

function showMsg(t, ok){
  const m=document.getElementById("msg");
  m.textContent=t;
  m.className="msg "+(ok?"ok":"err");
}

function renderDemos(){
  const g=document.getElementById("demoGrid");
  g.innerHTML="";
  DEMOS.forEach(d=>{
    const el=document.createElement("div");
    el.className="demo";
    el.innerHTML=`<img src="${d.img}"><div class="txt">${d.name}</div>`;
    el.onclick=()=>{
      selectedDemo=d.id;
      [...g.children].forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
    };
    g.appendChild(el);
  });
}

async function initLIFF(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if(liff.isLoggedIn()){
      const p=await liff.getProfile();
      userId=p.userId;
      displayName=p.displayName;
    }
  }catch(e){
    // 不顯示錯誤，避免干擾 UX
  }
}

async function submit(){
  const btn=document.getElementById("submitBtn");
  btn.disabled=true;
  showMsg("送出中…",true);

  try{
    const payload={
      demo:selectedDemo,
      lastName:lastName.value.trim(),
      title:title.value,
      phone:phone.value.trim(),
      note:note.value.trim(),
      userId,displayName
    };

    if(!payload.demo||!payload.lastName||!payload.title||!payload.phone)
      throw new Error();

    const body=JSON.stringify(payload);

    // ✅ 不讀回應，避免 failed to fetch
    if(navigator.sendBeacon){
      navigator.sendBeacon(API_URL,new Blob([body],{type:"text/plain"}));
    }else{
      await fetch(API_URL,{method:"POST",mode:"no-cors",body});
    }

    showMsg("✅ 預約成功",true);

    if(window.liff && liff.isInClient()){
      liff.sendMessages([{type:"text",text:"已收到您的預約 ✅"}])
        .then(()=>setTimeout(()=>liff.closeWindow(),600));
    }

  }catch(e){
    showMsg("❌ 預約失敗",false);
  }finally{
    btn.disabled=false;
  }
}

renderDemos();
initLIFF();
submitBtn.onclick=submit;
</script>
</body>
</html>
